<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Payment Success - MentorMatch</title>
    <link rel="stylesheet" href="../css/style.css" />
</head>
<body>
    <header>
        <img class="logo" alt="Logo" src="../assets/Logo.svg" />
        <nav>
            <a href="index.html">HOME</a>
            <a href="dashboardMentee.html">DASHBOARD</a>
            <a href="#">LOGOUT</a>
        </nav>
    </header>

    <div class="payment-success-container">
        <div class="success-card">
            <div class="success-icon">‚úÖ</div>
            <h1>Payment Completed!</h1>
            <p>Your session has been booked successfully.</p>

            <button class="submit-payment-btn" onclick="goToDashboard()">Back to Dashboard</button>
        </div>
    </div>


    <script src="../js/utils.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üîµ Payment Success Page Loaded');

            // Controlla il metodo di pagamento
            const paymentMethod = sessionStorage.getItem('paymentMethod');
            const params = new URLSearchParams(window.location.search);
            const orderId = params.get('token');

            console.log('üìã Payment Method:', paymentMethod);
            console.log('üìã Order ID (token):', orderId);

            // Se √® pagamento PayPal, cattura l'ordine
            if (!paymentMethod || paymentMethod === 'paypal') {
                if (orderId) {
                    // Leggi i dati salvati in sessionStorage
                    const paypalOrderData = JSON.parse(sessionStorage.getItem('paypalOrderData') || '{}');
                    console.log('üì¶ PayPal Order Data from Session:', paypalOrderData);

                    // Cattura l'ordine PayPal
                    try {
                        const token = getToken();
                        console.log('üîë Auth Token exist:', !!token);

                        const capturePayload = {
                            orderId: orderId,
                            prenotazioneId: paypalOrderData.prenotazioneId,
                            importo: paypalOrderData.importo
                        };
                        console.log('üì§ Sending capture request:', capturePayload);

                        const res = await fetch('/api/payments/paypal/confirm', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(capturePayload)
                        });

                        const data = await res.json();
                        console.log('üì• Capture Response:', { ok: res.ok, status: res.status, data });

                        if (!res.ok || !data.success) {
                            console.error('‚ùå Capture error:', data.error || 'Payment capture failed');
                        } else {
                            console.log('‚úÖ Payment captured successfully!');
                        }

                        sessionStorage.removeItem('paypalOrderData');
                    } catch (error) {
                        console.error('‚ùå Error capturing PayPal order:', error);
                    }
                } else {
                    console.warn('‚ö†Ô∏è No order token (token param) in URL for PayPal payment');
                }
            } else if (paymentMethod === 'card') {
                console.log('‚úÖ Card payment already processed');
                // Card payment √® gi√† stato processato e salvato nel DB dal backend
            }

            // Pulisci session storage
            sessionStorage.removeItem('pendingPayment');
            localStorage.removeItem('pendingPayment');
            sessionStorage.removeItem('paymentMethod');
        });

        function goToDashboard() {
            const user = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
            const userRole = (user.ruolo || '').toLowerCase();
            
            if (userRole === 'mentor') {
                window.location.href = '/pages/dashboardMentor.html';
            } else if (userRole === 'mentee') {
                window.location.href = '/pages/dashboardMentee.html';
            } else {
                window.location.href = '/pages/index.html';
            }
        }
    </script>
</body>
</html>
